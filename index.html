<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LinguaParrot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --tg-bg: var(--tg-theme-bg-color, #F8F9FA);
            --tg-text: var(--tg-theme-text-color, #2C3E50);
            --tg-hint: var(--tg-theme-hint-color, #7F8C8D);
            --tg-link: var(--tg-theme-link-color, #2D7A5F);
            --tg-button: var(--tg-theme-button-color, #2D7A5F);
            --tg-button-text: var(--tg-theme-button-text-color, #FFFFFF);
            --primary: #2D7A5F;
            --primary-light: #3D9A7A;
            --accent: #F4A261;
            --success: #27AE60;
            --error: #E74C3C;
            --shadow: 0 4px 20px rgba(0,0,0,0.08); 
            --street-primary: #FF6B35;
--street-accent: #F7C59F;
--street-dark: #1A1A2E;
--street-gold: #FFD700;

        }
        
        body { 
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--tg-bg); 
            color: var(--tg-text); 
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .app-container { max-width: 430px; margin: 0 auto; min-height: 100vh; position: relative; padding: 16px; }
        
        .tg-header {
            position: sticky;
            top: 0;
            background: var(--tg-bg);
            z-index: 100;
            padding: 8px 0 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .tg-header-title {
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tg-close-btn {
            position: absolute;
            top: 8px;
            right: 0;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-hint);
        }
        
        .tg-main-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            padding: 16px 24px 32px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .tg-main-btn.show { transform: translateY(0); }
        
        .card {
            background: var(--tg-theme-secondary-bg-color, #FFFFFF);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        
        .daily-goal {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px;
            padding: 24px;
            color: white;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .goal-title { font-size: 17px; font-weight: 700; opacity: 0.9; }
        .goal-time { font-size: 28px; font-weight: 800; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; border-radius: 3px; transition: width 0.5s ease; width: 0%; }
        .mode-toggle {
    display: flex;
    background: var(--tg-theme-secondary-bg-color, #FFFFFF);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

body.street-mode .mode-toggle {
    background: rgba(255,255,255,0.05);
}

.mode-btn {
    flex: 1;
    padding: 12px 4px;
    border: none;
    background: transparent;
    border-radius: 10px;
    font-family: inherit;
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
    color: var(--tg-hint);
    transition: all 0.2s ease;
}

body.street-mode .mode-btn {
    color: rgba(255,255,255,0.6);
}

.mode-btn.active { 
    background: var(--primary); 
    color: white; 
}

body.street-mode .mode-btn.active {
    background: #FF6B35;
}


        
        .tutor-card {
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .tutor-card:active { transform: scale(0.98); }
        
        .tutor-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent) 0%, #F4D35E 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
            flex-shrink: 0;
        }
        
        .tutor-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--success);
            border: 2px solid white;
            border-radius: 50%;
        }
        
        .tutor-info { flex: 1; }
        .tutor-name { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .tutor-status { font-size: 14px; color: var(--tg-hint); display: flex; align-items: center; gap: 6px; }
        .pulse { animation: pulse 2s infinite; color: var(--success); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .arrow { color: var(--tg-hint); font-size: 20px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { text-align: center; padding: 20px 16px; }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: var(--tg-hint); font-weight: 600; }
        
        .section-title { font-size: 17px; font-weight: 700; margin-bottom: 12px; margin-top: 8px; }
        
        .level-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .level-card {
            background: var(--tg-theme-secondary-bg-color, #FFFFFF);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }
        
        .level-card:active { transform: scale(0.98); }
        .level-card.active { border-color: var(--primary); }
        .level-card.locked { opacity: 0.5; pointer-events: none; }
        
        .level-number {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            margin: 0 auto 12px;
        }
        
        .level-card.locked .level-number { background: var(--tg-hint); }
        .level-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .level-progress { font-size: 13px; color: var(--tg-hint); }
        .level-status { position: absolute; top: 8px; right: 8px; font-size: 20px; }
        
        .lesson-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--tg-bg);
            z-index: 100;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .lesson-screen.active { display: block; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .lesson-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--tg-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--tg-theme-secondary-bg-color, #F0F0F0);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-dots { display: flex; gap: 6px; flex: 1; justify-content: center; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--tg-hint); opacity: 0.3; transition: all 0.3s ease; }
        .dot.active { background: var(--primary); opacity: 1; width: 20px; border-radius: 3px; }
        .dot.completed { background: var(--success); opacity: 1; }
        
        .flashcard-container { padding: 20px 16px 100px; }
        
        .flashcard {
            background: var(--tg-theme-secondary-bg-color, #FFFFFF);
            border-radius: 20px;
            padding: 40px 24px;
            text-align: center;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .flashcard.flipped { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .flashcard-word { font-size: 32px; font-weight: 800; margin-bottom: 16px; }
        .flashcard-trans { font-size: 15px; opacity: 0.6; margin-bottom: 8px; font-family: monospace; }
        .flashcard-rus-trans { font-size: 16px; color: var(--accent); margin-bottom: 20px; font-weight: 600; display: none; }
        .flashcard.flipped .flashcard-rus-trans { color: rgba(255,255,255,0.9); display: block; }
        .flashcard-meaning { font-size: 24px; font-weight: 700; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .flashcard.flipped .flashcard-meaning { opacity: 1; transform: translateY(0); }
        
        .flip-hint {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            opacity: 0.5;
            background: rgba(0,0,0,0.05);
            padding: 6px 14px;
            border-radius: 20px;
        }
        
        .detail-card {
            background: rgba(45, 122, 95, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            display: none;
        }
        
        .detail-card.show { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .detail-title { font-size: 13px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .detail-example { font-size: 16px; font-style: italic; margin-bottom: 8px; padding: 16px; background: var(--tg-theme-secondary-bg-color, #FFFFFF); border-radius: 12px; }
        .detail-translation { font-size: 14px; color: var(--tg-hint); padding-left: 12px; border-left: 3px solid var(--accent); }
        
        .trans-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #FFFFFF);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 15px;
            font-weight: 600;
        }
        
        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--tg-hint);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.3;
        }
        
        .toggle-switch.active { background: var(--primary); opacity: 1; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after { left: 26px; }
        
        .result-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--tg-bg);
            z-index: 200;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 24px;
            text-align: center;
        }
        
        .result-screen.active { display: flex; }
        .result-emoji { font-size: 80px; margin-bottom: 20px; }
        .result-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .result-subtitle { color: var(--tg-hint); margin-bottom: 32px; }
        
        .result-stats {
            background: var(--tg-theme-secondary-bg-color, #FFFFFF);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 24px;
        }
        
        .result-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 16px; }
        .result-row:last-child { border-bottom: none; }
        .result-value { font-weight: 800; color: var(--primary); }
        .result-value.xp { color: var(--accent); }
        
        .haptic:active { opacity: 0.7; }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <div class="screen active" id="mainScreen">
            <div class="tg-header">
                <div class="tg-header-title">ü¶ú LinguaParrot</div>
                <button class="tg-close-btn" onclick="tg.close()">‚úï</button>
            </div>
            
            <div class="daily-goal">
                <div class="goal-header">
                    <div>
                        <div class="goal-title">–¶–µ–ª—å –¥–Ω—è</div>
                        <div class="goal-time"><span id="dailyProgress">0</span>/15 –º–∏–Ω</div>
                    </div>
                    <div style="font-size: 40px;">üî•</div>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            </div>
            
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode(this, 'calm')">üåø –°–ø–æ–∫–æ–π–Ω—ã–π</button>
                <button class="mode-btn" onclick="setMode(this, 'strict')">üìö –°—Ç—Ä–æ–≥–∏–π</button>
                <button class="mode-btn" onclick="setMode(this, 'street')">üî• Street</button>

            </div>
            <!-- Street Stats (visible only in street mode) -->
<div class="street-stats" id="streetStats" style="display: none;">
    <div class="street-header">
        <div class="street-title">üé§ STREET CRED</div>
        <div class="cred-badge">
            <span>‚ö°</span>
            <span id="streetCred">0</span>
        </div>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="streetProgress" style="width: 0%"></div>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; opacity: 0.8;">
        <span>–£—Ä–æ–≤–µ–Ω—å <span id="streetLevel">1</span></span>
        <span><span id="streetNext">100</span> –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ</span>
    </div>
</div>
<div id="standardContent">

            <div class="card tutor-card haptic" onclick="openChat()">
                <div class="tutor-avatar">ü¶ú</div>
                <div class="tutor-info">
                    <div class="tutor-name">–ü–æ–ø—É–≥–∞–π-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä</div>
                    <div class="tutor-status"><span class="pulse">‚óè</span> –û–Ω–ª–∞–π–Ω ‚Ä¢ –ù–∞–∂–º–∏ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
                </div>
                <div class="arrow">‚Ä∫</div>
            </div>
            
            <div class="stats-grid">
                <div class="card stat-card">
                    <div class="stat-value" id="wordsCount">0</div>
                    <div class="stat-label">–°–ª–æ–≤ –∏–∑—É—á–µ–Ω–æ</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                </div>
            </div>
            
            <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å</div>
            <div class="level-grid" id="levelGrid"></div>
        </div>
        </div>
<!-- Street Content (visible only in street mode) -->
<div id="streetContent" style="display: none;">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="setTab('slang')">üéØ –°–ª–µ–Ω–≥</button>
        <button class="tab-btn" onclick="setTab('tracks')">üéµ –¢—Ä–µ–∫–∏</button>
    </div>
    
    <!-- Slang Tab -->
    <div class="tab-content active" id="slangTab">
        <div class="section-title">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>
        <div class="category-grid">
            <div class="category-card active" onclick="selectCategory('oldschool', this)">
                <div class="category-emoji">üìª</div>
                <div class="category-name">Old School</div>
            </div>
            <div class="category-card" onclick="selectCategory('modern', this)">
                <div class="category-emoji">üî•</div>
                <div class="category-name">Modern</div>
            </div>
            <div class="category-card" onclick="selectCategory('trap', this)">
                <div class="category-emoji">üöÄ</div>
                <div class="category-name">Trap</div>
            </div>
        </div>
        
        <div class="section-title">–ò–∑—É—á–∏ —Å–ª–µ–Ω–≥</div>
        <div class="level-grid" id="slangGrid"></div>
    </div>
    
    <!-- Tracks Tab -->
    <div class="tab-content" id="tracksTab">
        <!-- Sections: All / Favorites / My Tracks -->
        <div class="tracks-sections">
            <button class="section-tab active" onclick="setTrackSection('all')">–í—Å–µ</button>
            <button class="section-tab" onclick="setTrackSection('favorites')">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button class="section-tab" onclick="setTrackSection('custom')">üì§ –ú–æ–∏</button>
        </div>
        
        <!-- Search and Filter (for All and Favorites) -->
        <div id="tracksFilterSection">
            <div class="search-container">
                <input type="text" class="search-input" id="trackSearch" placeholder="–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤..." oninput="filterTracks()">
                <span class="search-icon">üîç</span>
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" onclick="setDifficultyFilter('all')">–í—Å–µ</button>
                <button class="filter-btn" onclick="setDifficultyFilter('easy')">Easy</button>
                <button class="filter-btn" onclick="setDifficultyFilter('medium')">Medium</button>
                <button class="filter-btn" onclick="setDifficultyFilter('hard')">Hard</button>
            </div>
        </div>
        
        <!-- Upload Section (for Custom) -->
        <div class="upload-section" id="uploadSection" onclick="showUploadForm()" style="display: none;">
            <div class="upload-icon">üì§</div>
            <div class="upload-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ç—Ä–µ–∫</div>
            <div class="upload-hint">–î–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞</div>
        </div>
        
        <!-- Custom Track Form -->
        <div class="custom-track-form" id="customTrackForm">
            <div class="form-group">
                <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                <input type="text" class="form-input" id="customArtist" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Eminem">
            </div>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
                <input type="text" class="form-input" id="customTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Lose Yourself">
            </div>
            <div class="form-group">
                <label class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                <select class="form-input" id="customDifficulty">
                    <option value="easy">Easy (–õ–µ–≥–∫–æ)</option>
                    <option value="medium" selected>Medium (–°—Ä–µ–¥–Ω–µ)</option>
                    <option value="hard">Hard (–°–ª–æ–∂–Ω–æ)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</label>
                <textarea class="form-textarea" id="customLyrics" placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –∑–¥–µ—Å—å...&#10;&#10;–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.&#10;–°–ª–µ–Ω–≥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ –±–∞–∑–µ."></textarea>
                <div class="form-hint">–ú—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–∏–º —Ä–∞–∑–±–æ—Ä —Å–ª–µ–Ω–≥–∞</div>
            </div>
            <div class="form-actions">
                <button class="form-btn secondary" onclick="hideUploadForm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="form-btn primary" onclick="saveCustomTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="section-title" id="tracksListTitle">–í—Å–µ —Ç—Ä–µ–∫–∏</div>
        <div class="track-list" id="trackList"></div>
    </div>
</div>

        <div class="lesson-screen" id="lessonScreen">
            <div class="lesson-header">
                <button class="back-btn haptic" onclick="closeLesson()">‚Üê</button>
                <div class="progress-dots" id="progressDots"></div>
                <div style="width: 36px;"></div>
            </div>
            
            <div class="flashcard-container">
                <div class="trans-toggle">
                    <span>üî§ –†—É—Å—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</span>
                    <div class="toggle-switch" id="transToggle" onclick="toggleTrans()"></div>
                </div>
                
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-word" id="cardWord"></div>
                    <div class="flashcard-trans" id="cardTrans"></div>
                    <div class="flashcard-rus-trans" id="cardRusTrans"></div>
                    <div class="flashcard-meaning" id="cardMeaning"></div>
                    <div class="flip-hint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</div>
                </div>
                
                <div class="detail-card" id="detailCard">
                    <div class="detail-title">üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</div>
                    <div class="detail-example" id="detailExample"></div>
                    <div class="detail-translation" id="detailTranslation"></div>
                </div>
            </div>
        </div>
        <!-- Track Analysis Screen -->
<div class="track-analysis-screen" id="trackAnalysisScreen">
    <div class="lesson-header">
        <button class="back-btn haptic" onclick="closeTrackAnalysis()">‚Üê</button>
        <div style="flex: 1; text-align: center; font-weight: 700;" id="analysisTitle">–†–∞–∑–±–æ—Ä —Ç—Ä–µ–∫–∞</div>
        <div style="width: 36px;"></div>
    </div>
    
    <div class="track-player" id="trackPlayer">
        <div class="track-visual" id="trackVisual">üéµ</div>
        
        <div class="visualizer paused" id="visualizer">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        
        <div class="track-controls">
            <button class="control-btn secondary" onclick="skipBackward()">‚èÆ</button>
            <button class="control-btn play" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
            <button class="control-btn secondary" onclick="skipForward()">‚è≠</button>
        </div>
        
        <div class="track-progress">
            <div class="track-progress-fill" id="trackProgress"></div>
        </div>
        <div class="track-time">
            <span id="currentTime">0:00</span>
            <span id="totalTime">0:30</span>
        </div>
        
        <button class="analysis-btn" onclick="showAnalysis()">
            üîç –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–∑–±–æ—Ä—É
        </button>
    </div>
    
    <div class="lyrics-container" id="lyricsContainer">
        <div class="lyrics-header">
            <div class="lyrics-title" id="lyricsTitle">–†–∞–∑–±–æ—Ä</div>
            <div class="difficulty-badge" id="difficultyBadge">Medium</div>
        </div>
        <div id="lyricsContent"></div>
        
        <button class="analysis-btn" onclick="backToPlayer()" style="margin-top: 20px; width: 100%;">
            üéµ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç—Ä–µ–∫—É
        </button>
    </div>
</div>

        <div class="result-screen" id="resultScreen">
            <div class="result-emoji">üéâ</div>
            <div class="result-title">–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</div>
            <div class="result-subtitle" id="resultSubtitle"></div>
            
            <div class="result-stats">
                <div class="result-row">
                    <span>–ò–∑—É—á–µ–Ω–æ —Å–ª–æ–≤</span>
                    <span class="result-value" id="resultWords">10</span>
                </div>
                <div class="result-row">
                    <span>–í—Ä–µ–º—è</span>
                    <span class="result-value" id="timeValue">0:00</span>
                </div>
                <div class="result-row">
                    <span>–û–ø—ã—Ç</span>
                    <span class="result-value xp" id="resultXP">+100 XP</span>
                </div>
            </div>
            
            <button class="tg-main-btn show" onclick="finishLesson()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Data: Standard Levels (—Ç–≤–æ–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Ä–æ–≤–Ω–∏)
const levels = [
    // ... –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ç–≤–æ–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ 5 —É—Ä–æ–≤–Ω–µ–π ...
    {
        id: 1,
        name: '–ù–æ–≤–∏—á–æ–∫',
        description: '–ë–∞–∑–æ–≤—ã–µ —Å–ª–æ–≤–∞',
        words: [
            { word: 'Serendipity', trans: '/Àåser.…ônÀàd…™p.…ô.ti/', rus: '[—Å—ç-—Ä—ç–Ω-–¥–∏-–ø–∏-—Ç–∏]', meaning: '–°—á–∞—Å—Ç–ª–∏–≤–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å', example: '"Meeting her was pure serendipity."', exampleRu: '"–í—Å—Ç—Ä–µ—á–∞ —Å –Ω–µ–π –±—ã–ª–∞ —á–∏—Å—Ç–æ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å—é"' },
            { word: 'Ephemeral', trans: '/…™Ààfem.…ôr.…ôl/', rus: '[–∏-—Ñ—ç-–º—ç-—Ä–ª]', meaning: '–ú–∏–º–æ–ª—ë—Ç–Ω—ã–π', example: '"Fame in the internet age is ephemeral."', exampleRu: '"–°–ª–∞–≤–∞ –≤ —ç–ø–æ—Ö—É –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –º–∏–º–æ–ª—ë—Ç–Ω–∞."' },
            { word: 'Resilience', trans: '/r…™Ààz…™l.j…ôns/', rus: '[—Ä–∏-–∑–∏-–ª–π—ç–Ω—Å]', meaning: '–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å', example: '"Her resilience helped her overcome all difficulties."', exampleRu: '"–ï—ë –∂–∏–∑–Ω–µ—Å—Ç–æ–π–∫–æ—Å—Ç—å –ø–æ–º–æ–≥–ª–∞ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏."' },
            { word: 'Eloquent', trans: '/Ààel.…ô.kw…ônt/', rus: '[—ç-–ª—ç-–∫–≤—ç–Ω—Ç]', meaning: '–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–≤—ã–π', example: '"He gave an eloquent speech about freedom."', exampleRu: '"–û–Ω –ø—Ä–æ–∏–∑–Ω—ë—Å –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–≤—É—é —Ä–µ—á—å –æ —Å–≤–æ–±–æ–¥–µ."' },
            { word: 'Mellifluous', trans: '/meÀàl…™f.lu.…ôs/', rus: '[–º—ç-–ª–∏-—Ñ–ª—É-—ç—Å]', meaning: '–ú–µ–¥–æ–≤—ã–π, –ø–ª–∞–≤–Ω—ã–π', example: '"She had a rich, mellifluous voice."', exampleRu: '"–£ –Ω–µ—ë –±—ã–ª –±–æ–≥–∞—Ç—ã–π, –ø–ª–∞–≤–Ω—ã–π –≥–æ–ª–æ—Å."' }
        ]
    }
];

// Data: Slang with Russian Transcription
const slangData = {
    oldschool: [
        {
            id: 'oldschool-1',
            name: 'Old School Basics',
            description: '–ö–ª–∞—Å—Å–∏–∫–∞ 90-—Ö',
            words: [
                { word: 'Dope', trans: '/d…ô äp/', rus: '[–¥oup]', meaning: '–ö—Ä—É—Ç–æ–π, –∫–ª–∞—Å—Å–Ω—ã–π', example: '"That beat is dope!"', exampleRu: '"–≠—Ç–æ—Ç –±–∏—Ç –∫—Ä—É—Ç–æ–π!"', context: '–û–¥–Ω–æ –∏–∑ —Å–∞–º—ã—Ö —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö —Å–ª–æ–≤ 90-—Ö', origin: '–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ "–Ω–∞—Ä–∫–æ—Ç–∏–∫", –ø–µ—Ä–µ—à–ª–æ –≤ –∑–Ω–∞—á–µ–Ω–∏–µ "–∫—Ä—É—Ç–æ"' },
                { word: 'Fresh', trans: '/fre É/', rus: '[—Ñ—Ä—ç—à]', meaning: '–°–≤–µ–∂–∏–π, —Å—Ç–∏–ª—å–Ω—ã–π', example: '"His style is so fresh."', exampleRu: '"–ï–≥–æ —Å—Ç–∏–ª—å —Ç–∞–∫–æ–π —Å–≤–µ–∂–∏–π."' },
                { word: 'Word is bond', trans: '/w…úÀêd …™z b…índ/', rus: '[–≤–æ—Ä–¥ –∏–∑ –±–æ–Ω–¥]', meaning: '–ß–µ—Å—Ç–Ω–æ–µ —Å–ª–æ–≤–æ', example: '"Word is bond, I\'ll be there."', exampleRu: '"–ß–µ—Å—Ç–Ω–æ–µ —Å–ª–æ–≤–æ, —è –±—É–¥—É —Ç–∞–º."' },
                { word: 'Props', trans: '/pr…íps/', rus: '[–ø—Ä–æ–ø—Å]', meaning: '–£–≤–∞–∂–µ–Ω–∏–µ, —Ä–µ—Å–ø–µ–∫—Ç', example: '"Mad props to the DJ."', exampleRu: '"–û–≥—Ä–æ–º–Ω—ã–π —Ä–µ—Å–ø–µ–∫—Ç –¥–∏–¥–∂–µ—é."' },
                { word: 'Def', trans: '/def/', rus: '[–¥–µ—Ñ]', meaning: '–û—Ç–ª–∏—á–Ω—ã–π', example: '"That\'s def, man!"', exampleRu: '"–≠—Ç–æ –∫—Ä—É—Ç–æ, —á—É–≤–∞–∫!"' }
            ]
        },
        {
            id: 'oldschool-2',
            name: 'Hip-Hop Culture',
            description: '–¢–µ—Ä–º–∏–Ω—ã –∫—É–ª—å—Ç—É—Ä—ã',
            words: [
                { word: 'Cypher', trans: '/Ààsa…™.f…ôr/', rus: '[—Å–∞–π-—Ñ—ç]', meaning: '–ö—Ä—É–≥ —Ä—ç–ø–µ—Ä–æ–≤, —Ñ—Ä–∏—Å—Ç–∞–π–ª', example: '"They\'re having a cypher in the park."', exampleRu: '"–û–Ω–∏ —É—Å—Ç—Ä–∞–∏–≤–∞—é—Ç —Ñ—Ä–∏—Å—Ç–∞–π–ª-–∫—Ä—É–≥ –≤ –ø–∞—Ä–∫–µ."' },
                { word: 'Flow', trans: '/fl…ô ä/', rus: '[—Ñ–ª–æ—É]', meaning: '–ü–æ–¥–∞—á–∞, —Ä–∏—Ç–º —Ä–µ—á–∏', example: '"His flow is incredible."', exampleRu: '"–ï–≥–æ –ø–æ–¥–∞—á–∞ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–∞—è."' },
                { word: 'Diss', trans: '/d…™s/', rus: '[–¥–∏—Å]', meaning: '–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ, –∑–∞–¥–∏—Å–∏—Ç—å', example: '"He dissed his rival in the track."', exampleRu: '"–û–Ω –∑–∞–¥–∏—Å—Å–∏–ª —Å–≤–æ–µ–≥–æ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –≤ —Ç—Ä–µ–∫–µ."' },
                { word: 'Beef', trans: '/biÀêf/', rus: '[–±–∏—Ñ]', meaning: '–í—Ä–∞–∂–¥–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç', example: '"There\'s beef between those rappers."', exampleRu: '"–ú–µ–∂–¥—É —ç—Ç–∏–º–∏ —Ä—ç–ø–µ—Ä–∞–º–∏ –≤—Ä–∞–∂–¥–∞."' },
                { word: 'Mic', trans: '/ma…™k/', rus: '[–º–∞–π–∫]', meaning: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω', example: '"Pass the mic!"', exampleRu: '"–ü–µ—Ä–µ–¥–∞–π –º–∏–∫—Ä–æ—Ñ–æ–Ω!"' }
            ]
        }
    ],
    modern: [
        {
            id: 'modern-1',
            name: 'Modern Classics',
            description: '–°–ª–µ–Ω–≥ 2010-—Ö',
            words: [
                { word: 'Lit', trans: '/l…™t/', rus: '[–ª–∏—Ç]', meaning: '–ó–∞–∂–∏–≥–∞—Ç–µ–ª—å–Ω–æ, –≤–µ—Å–µ–ª–æ', example: '"The party was lit!"', exampleRu: '"–í–µ—á–µ—Ä–∏–Ω–∫–∞ –±—ã–ª–∞ –æ–≥–æ–Ω—å!"' },
                { word: 'Savage', trans: '/Ààs√¶v.…™d í/', rus: '[—Å—ç-–≤–∏–¥–∂]', meaning: '–ñ–µ—Å—Ç–æ–∫–∏–π, –±–µ—Å–ø–æ—â–∞–¥–Ω—ã–π', example: '"That comeback was savage."', exampleRu: '"–≠—Ç–∞ –æ—Ç–ø–æ–≤–µ–¥—å –±—ã–ª–∞ –±–µ—Å–ø–æ—â–∞–¥–Ω–æ–π."' },
                { word: 'Slay', trans: '/sle…™/', rus: '[—Å–ª—ç–π]', meaning: '–£–±–∏—Ç—å (–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ)', example: '"You slay in that outfit!"', exampleRu: '"–¢—ã —É–±–∏–≤–∞–µ—à—å –≤ —ç—Ç–æ–º –Ω–∞—Ä—è–¥–µ!"' },
                { word: 'Goals', trans: '/…°…ô älz/', rus: '[–≥–æ–ª–∑]', meaning: '–¶–µ–ª—å, –∏–¥–µ–∞–ª', example: '"Their relationship is goals."', exampleRu: '"–ò—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî —ç—Ç–æ —Ü–µ–ª—å."' },
                { word: 'Tea', trans: '/tiÀê/', rus: '[—Ç–∏]', meaning: '–°–ø–ª–µ—Ç–Ω–∏, –Ω–æ–≤–æ—Å—Ç–∏', example: '"Spill the tea!"', exampleRu: '"–í—ã–¥–∞–π —Å–ø–ª–µ—Ç–Ω–∏!"' }
            ]
        },
        {
            id: 'modern-2',
            name: 'Social Media',
            description: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–ª–µ–Ω–≥',
            words: [
                { word: 'Flex', trans: '/fleks/', rus: '[—Ñ–ª–µ–∫—Å]', meaning: '–•–≤–∞—Å—Ç–∞—Ç—å—Å—è', example: '"He\'s always flexing on Instagram."', exampleRu: '"–û–Ω –≤–µ—á–Ω–æ —Ö–≤–∞—Å—Ç–∞–µ—Ç—Å—è –≤ –ò–Ω—Å—Ç–∞–≥—Ä–∞–º–µ."' },
                { word: 'Ghost', trans: '/…°…ô äst/', rus: '[–≥–æ—É—Å—Ç]', meaning: '–ò–≥–Ω–æ—Ä–∏—Ç—å', example: '"She ghosted him after the date."', exampleRu: '"–û–Ω–∞ –∑–∞–≥–æ—É—Å—Ç–∏–ª–∞ –µ–≥–æ –ø–æ—Å–ª–µ —Å–≤–∏–¥–∞–Ω–∏—è."' },
                { word: 'Clout', trans: '/kla ät/', rus: '[–∫–ª–∞—É—Ç]', meaning: '–í–ª–∏—è–Ω–∏–µ, —Ö–∞–π–ø', example: '"He\'s chasing clout on TikTok."', exampleRu: '"–û–Ω –≥–æ–Ω–∏—Ç—Å—è –∑–∞ —Ö–∞–π–ø–æ–º –≤ –¢–∏–∫–¢–æ–∫–µ."' },
                { word: 'Salty', trans: '/Ààs…îÀêl.ti/', rus: '[—Å–æ–ª—Ç–∏]', meaning: '–ó–ª–æ–π, –æ–±–∏–∂–µ–Ω–Ω—ã–π', example: '"Why are you so salty?"', exampleRu: '"–ü–æ—á–µ–º—É —Ç—ã —Ç–∞–∫–æ–π –∑–ª–æ–π?"' },
                { word: 'Thirsty', trans: '/ÀàŒ∏…úÀês.ti/', rus: '[—Ñ—ë—Ä—Å—Ç–∏]', meaning: '–û—Ç—á–∞—è–Ω–Ω–æ –∂–µ–ª–∞—é—â–∏–π', example: '"He\'s so thirsty for attention."', exampleRu: '"–û–Ω —Ç–∞–∫ –æ—Ç—á–∞—è–Ω–Ω–æ –∂–∞–∂–¥–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è."' }
            ]
        }
    ],
    trap: [
        {
            id: 'trap-1',
            name: 'Trap Basics',
            description: '–û—Å–Ω–æ–≤—ã —Ç—Ä—ç–ø–∞',
            words: [
                { word: 'Drip', trans: '/dr…™p/', rus: '[–¥—Ä–∏–ø]', meaning: '–°—Ç–∏–ª—å, –æ–¥–µ–∂–¥–∞', example: '"Check out my drip!"', exampleRu: '"–°–º–æ—Ç—Ä–∏ –Ω–∞ –º–æ–π —Å—Ç–∏–ª—å!"' },
                { word: 'Ice', trans: '/a…™s/', rus: '[–∞–π—Å]', meaning: '–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã, —É–∫—Ä–∞—à–µ–Ω–∏—è', example: '"He\'s covered in ice."', exampleRu: '"–û–Ω –≤–µ—Å—å –≤ –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–∞—Ö."' },
                { word: 'No cap', trans: '/n…ô ä k√¶p/', rus: '[–Ω–æ –∫—ç–ø]', meaning: '–ë–µ–∑ —à—É—Ç–æ–∫, —á–µ—Å—Ç–Ω–æ', example: '"No cap, that was the best concert."', exampleRu: '"–ë–µ–∑ –∫—ç–ø–∞, —ç—Ç–æ –±—ã–ª –ª—É—á—à–∏–π –∫–æ–Ω—Ü–µ—Ä—Ç."' },
                { word: 'Bussin', trans: '/Ààb ås.…™n/', rus: '[–±–∞—Å—Å–∏–Ω]', meaning: '–û—á–µ–Ω—å –≤–∫—É—Å–Ω—ã–π', example: '"This food is bussin!"', exampleRu: '"–≠—Ç–∞ –µ–¥–∞ –±–æ–º–±–∞!"' },
                { word: 'Bet', trans: '/bet/', rus: '[–±—ç—Ç]', meaning: '–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å, –æ–∫–µ–π', example: '"You coming tonight?" "Bet!"', exampleRu: '"–¢—ã –ø—Ä–∏–¥—ë—à—å —Å–µ–≥–æ–¥–Ω—è?" "–ë–µ—Ç!"' }
            ]
        },
        {
            id: 'trap-2',
            name: 'Trap Life',
            description: '–£–ª–∏—á–Ω–∞—è –∂–∏–∑–Ω—å',
            words: [
                { word: 'Opp', trans: '/…íp/', rus: '[–æ–ø]', meaning: '–í—Ä–∞–≥, –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫', example: '"Watch out for the opps."', exampleRu: '"–ë–µ—Ä–µ–≥–∏—Å—å –≤—Ä–∞–≥–æ–≤."' },
                { word: 'Shorty', trans: '/Àà É…îÀê.ti/', rus: '[—à–æ—Ä—Ç–∏]', meaning: '–î–µ–≤—É—à–∫–∞, –ø–æ–¥—Ä—É–≥–∞', example: '"That\'s my shorty right there."', exampleRu: '"–í–æ—Ç –º–æ—è –¥–µ–≤—É—à–∫–∞."' },
                { word: 'Whip', trans: '/w…™p/', rus: '[—É–∏–ø]', meaning: '–ú–∞—à–∏–Ω–∞', example: '"Look at that new whip!"', exampleRu: '"–°–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç—É –Ω–æ–≤—É—é —Ç–∞—á–∫—É!"' },
                { word: 'Bands', trans: '/b√¶ndz/', rus: '[–±—ç–Ω–¥–∑]', meaning: '–ü–∞—á–∫–∏ –¥–µ–Ω–µ–≥', example: '"He\'s making bands."', exampleRu: '"–û–Ω –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫—É—á—É –¥–µ–Ω–µ–≥."' },
                { word: 'Plug', trans: '/pl å…°/', rus: '[–ø–ª–∞–≥]', meaning: '–ü–æ—Å—Ç–∞–≤—â–∏–∫, —Å–≤—è–∑—å', example: '"I know a plug for tickets."', exampleRu: '"–Ø –∑–Ω–∞—é —á–µ–ª–æ–≤–µ–∫–∞ –¥–ª—è –±–∏–ª–µ—Ç–æ–≤."' }
            ]
        }
    ]
};

// Data: Tracks with Russian Transcription
const defaultTracks = [
    {
        id: 'track-1',
        artist: 'Travis Scott',
        title: 'Sicko Mode',
        emoji: 'üåµ',
        difficulty: 'medium',
        preview: 'https://example.com/sicko-mode-preview.mp3',
        lyrics: [
            {
                original: "Made this here with all the ice on in the booth",
                rusTrans: "[–ú—ç–π–¥ –∑–∏—Å —Ö–∏–∞ —É–∏–∑ –æ–ª –∑–∏ –∞–π—Å –æ–Ω –∏–Ω –∑–∏ –±—É—Ñ]",
                clean: "Made this here with all the diamonds/jewelry on in the recording studio",
                russian: "–°–¥–µ–ª–∞–ª —ç—Ç–æ –∑–¥–µ—Å—å, –≤–µ—Å—å –≤ –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–∞—Ö, –≤ —Å—Ç—É–¥–∏–∏",
                slang: [
                    { word: "ice", rusTrans: "[–∞–π—Å]", meaning: "–±—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã, —É–∫—Ä–∞—à–µ–Ω–∏—è", explanation: "–í —Ö–∏–ø-—Ö–æ–ø–µ 'ice' –æ–∑–Ω–∞—á–∞–µ—Ç –¥–æ—Ä–æ–≥–∏–µ —É–∫—Ä–∞—à–µ–Ω–∏—è —Å –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–∞–º–∏. –≠—Ç–æ —á–∞—Å—Ç—å –∫—É–ª—å—Ç—É—Ä—ã 'flex' ‚Äî –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –±–æ–≥–∞—Ç—Å—Ç–≤–∞." }
                ]
            },
            {
                original: "At the gate outside, when they pull up, they get me loose",
                rusTrans: "[–≠—Ç –∑–∏ –≥–µ–π—Ç –∞—É—Ç—Å–∞–π–¥, —É—ç–Ω –∑–µ–π –ø—É–ª –∞–ø, –∑–µ–π –≥–µ—Ç –º–∏ –ª—É—Å]",
                clean: "At the entrance outside, when they arrive in their cars, they get me excited/hyped",
                russian: "–£ –≤—Ö–æ–¥–∞ —Å–Ω–∞—Ä—É–∂–∏, –∫–æ–≥–¥–∞ –æ–Ω–∏ –ø–æ–¥—ä–µ–∑–∂–∞—é—Ç, –æ–Ω–∏ –≤–∑–±–∞–¥—Ä–∏–≤–∞—é—Ç –º–µ–Ω—è",
                slang: [
                    { word: "pull up", rusTrans: "[–ø—É–ª –∞–ø]", meaning: "–ø–æ–¥—ä–µ—Ö–∞—Ç—å, –ø—Ä–∏–±—ã—Ç—å", explanation: "–†–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –æ –ø—Ä–∏–±—ã—Ç–∏–∏ –Ω–∞ –º–∞—à–∏–Ω–µ, —á–∞—Å—Ç–æ –≤–Ω–µ–∑–∞–ø–Ω–æ –∏–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–Ω–æ." },
                    { word: "get me loose", rusTrans: "[–≥–µ—Ç –º–∏ –ª—É—Å]", meaning: "—Ä–∞—Å–∫—Ä–µ–ø–æ—Å—Ç–∏—Ç—å, –≤–∑–±–æ–¥—Ä–∏—Ç—å", explanation: "–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç—Ä–µ–∫–∞ ‚Äî –∫–æ–≥–¥–∞ –º—É–∑—ã–∫–∞ –∏–ª–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –∫—Ä—É—Ç—ã–µ, —á—Ç–æ —Ç—ã —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—à—å—Å—è –∏ –∫–∞–π—Ñ—É–µ—à—å." }
                ]
            },
            {
                original: "Yeah, Jump Out boys, that's Nike boys, hoppin' out coupes",
                rusTrans: "[–ô–µ–∞, –î–∂–∞–º–ø –ê—É—Ç –±–æ–π–∑, –∑—ç—Ç—Å –ù–∞–π–∫–∏ –±–æ–π–∑, —Ö–æ–ø–∏–Ω –∞—É—Ç –∫—É–ø—Å]",
                clean: "Yeah, guys who jump out of cars, wearing Nike, getting out of two-door cars",
                russian: "–î–∞, –ø–∞—Ä–Ω–∏ –≤—ã–ø—Ä—ã–≥–∏–≤–∞—é—Ç, –≤ –ù–∞–π–∫–µ, –≤—ã—Ö–æ–¥—è—Ç –∏–∑ –∫—É–ø–µ",
                slang: [
                    { word: "Jump Out boys", rusTrans: "[–¥–∂–∞–º–ø –∞—É—Ç –±–æ–π–∑]", meaning: "–ø–∞—Ä–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø—Ä—ã–≥–∏–≤–∞—é—Ç –∏–∑ –º–∞—à–∏–Ω", explanation: "–û—Ç—Å—ã–ª–∫–∞ –∫ –∫—É–ª—å—Ç—É—Ä–µ, –≥–¥–µ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–µ–∑–∂–∞–µ—Ç –Ω–∞ —Ç–∞—á–∫–∞—Ö –∏ —ç—Ñ—Ñ–µ–∫—Ç–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç." },
                    { word: "coupes", rusTrans: "[–∫—É–ø—Å]", meaning: "–¥–≤—É—Ö–¥–≤–µ—Ä–Ω—ã–µ –º–∞—à–∏–Ω—ã, –∫—É–ø–µ", explanation: "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –¥–≤—É—Ö–¥–≤–µ—Ä–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, —á–∞—Å—Ç–æ –¥–æ—Ä–æ–≥–∏–µ –∏ —Å—Ç–∏–ª—å–Ω—ã–µ." }
                ]
            }
        ]
    },
    {
        id: 'track-2',
        artist: 'Drake',
        title: 'God\'s Plan',
        emoji: 'ü¶â',
        difficulty: 'easy',
        preview: 'https://example.com/gods-plan-preview.mp3',
        lyrics: [
            {
                original: "She say, 'Do you love me?' I tell her, 'Only partly'",
                rusTrans: "[–®–∏ —Å–µ–π, '–î—É —é –ª–∞–≤ –º–∏?' –ê–π —Ç–µ–ª —Ö—ç, '–û—É–Ω–ª–∏ –ø–∞—Ä—Ç–ª–∏']",
                clean: "She asks if I love her, I tell her only partially",
                russian: "–û–Ω–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç '–¢—ã –º–µ–Ω—è –ª—é–±–∏—à—å?' –Ø –≥–æ–≤–æ—Ä—é –µ–π '–¢–æ–ª—å–∫–æ –æ—Ç—á–∞—Å—Ç–∏'",
                slang: [],
                explanation: "–ò–≥—Ä–∞ —Å–ª–æ–≤ –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å –æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª–Ω–æ–π –æ—Ç–¥–∞—á–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏–∑-–∑–∞ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏."
            },
            {
                original: "I only love my bed and my momma, I'm sorry",
                rusTrans: "[–ê–π –æ—É–Ω–ª–∏ –ª–∞–≤ –º–∞–π –±—ç–¥ —ç–Ω–¥ –º–∞–π –º–∞–º–∞, –∞–π–º —Å–æ—Ä–∏]",
                clean: "I only love my bed and my mother, I'm sorry",
                russian: "–Ø –ª—é–±–ª—é —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∫—Ä–æ–≤–∞—Ç—å –∏ —Å–≤–æ—é –º–∞–º—É, –∏–∑–≤–∏–Ω–∏",
                slang: [],
                explanation: "–ó–Ω–∞–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö: –∫–æ–º—Ñ–æ—Ä—Ç (–∫—Ä–æ–≤–∞—Ç—å) –∏ —Å–µ–º—å—è (–º–∞–º–∞) –≤–∞–∂–Ω–µ–µ —Ä–æ–º–∞–Ω—Ç–∏–∫–∏."
            }
        ]
    },
    {
        id: 'track-3',
        artist: 'Kendrick Lamar',
        title: 'HUMBLE.',
        emoji: 'ü¶ã',
        difficulty: 'hard',
        preview: 'https://example.com/humble-preview.mp3',
        lyrics: [
            {
                original: "Sit down, be humble",
                rusTrans: "[–°–∏—Ç –¥–∞—É–Ω, –±–∏ —Ö–∞–º–±–ª]",
                clean: "Be modest and respectful",
                russian: "–°—è–¥—å, –±—É–¥—å —Å–∫—Ä–æ–º–Ω—ã–º",
                slang: [],
                explanation: "–ì–ª–∞–≤–Ω—ã–π –ø–æ—Å—ã–ª —Ç—Ä–µ–∫–∞ ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Å–∫—Ä–æ–º–Ω–æ—Å—Ç–∏ –¥–∞–∂–µ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ."
            },
            {
                original: "Bitch, sit down, be humble",
                rusTrans: "[–ë–∏—á, —Å–∏—Ç –¥–∞—É–Ω, –±–∏ —Ö–∞–º–±–ª]",
                clean: "(aggressive) Be modest and respectful",
                russian: "–°—è–¥—å, –±—É–¥—å —Å–∫—Ä–æ–º–Ω—ã–º",
                slang: [
                    { word: "bitch", rusTrans: "[–±–∏—á]", meaning: "–ø—Ä–µ–Ω–µ–±—Ä–µ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ", explanation: "–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç—Ä–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —É—Å–∏–ª–∏—Ç–µ–ª—å —ç–º–æ—Ü–∏–∏, –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—É–∫–≤–∞–ª—å–Ω–æ." }
                ]
            },
            {
                original: "My left stroke just went viral",
                rusTrans: "[–ú–∞–π –ª–µ—Ñ—Ç —Å—Ç—Ä–æ—É–∫ –¥–∂–∞—Å—Ç —É—ç–Ω—Ç –≤–∞–π—Ä–∞–ª]",
                clean: "My left-sided approach/song became extremely popular",
                russian: "–ú–æ–π –ª–µ–≤—ã–π —Ö–æ–¥ —Å—Ç–∞–ª –≤–∏—Ä—É—Å–Ω—ã–º",
                slang: [
                    { word: "stroke", rusTrans: "[—Å—Ç—Ä–æ—É–∫]", meaning: "—É–¥–∞—Ä, —Ö–æ–¥", explanation: "–î–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å: '—É–¥–∞—Ä' –∫–∞–∫ –≤ —Å–ø–æ—Ä—Ç–µ/–±–æ–∫—Å–µ –∏ '—Ö–æ–¥' –∫–∞–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è." },
                    { word: "viral", rusTrans: "[–≤–∞–π—Ä–∞–ª]", meaning: "–≤–∏—Ä—É—Å–Ω—ã–π, –ø–æ–ø—É–ª—è—Ä–Ω—ã–π", explanation: "–ò–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–ª–µ–Ω–≥–∞ ‚Äî –∫–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –±—ã—Å—Ç—Ä–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è." }
                ]
            }
        ]
    }
];

// State
let currentMode = 'calm';
let currentCategory = 'oldschool';
let currentTrack = null;
let isPlaying = false;
let playInterval = null;
let currentPlayTime = 0;
let streetCred = 0;
let isStreetLesson = false;
let currentTrackSection = 'all';
let currentDifficultyFilter = 'all';
let favorites = [];
let customTracks = [];
let searchQuery = '';

const STORAGE_KEY = 'linguaparrot_progress_v3';

// Init
function init() {
    loadData();
    renderLevels();
    updateStreetStats();
}

function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        const data = JSON.parse(saved);
        streetCred = data.streetCred || 0;
        favorites = data.favorites || [];
        customTracks = data.customTracks || [];
    }
}

function saveData() {
    const data = {
        streetCred: streetCred,
        favorites: favorites,
        customTracks: customTracks,
        lastVisit: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Haptic
function haptic() {
    if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
    }
}

// Mode Switching
function setMode(btn, mode) {
    haptic();
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentMode = mode;
    
    if (mode === 'street') {
        document.body.classList.add('street-mode');
        renderSlangGrid();
        renderTrackList();
        updateStreetStats();
    } else {
        document.body.classList.remove('street-mode');
    }
}

// Tab Navigation
function setTab(tab) {
    haptic();
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
    
    if (tab === 'tracks') {
        renderTrackList();
    }
}

// Track Sections
function setTrackSection(section) {
    haptic();
    currentTrackSection = section;
    
    document.querySelectorAll('.section-tab').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    const filterSection = document.getElementById('tracksFilterSection');
    const uploadSection = document.getElementById('uploadSection');
    const customForm = document.getElementById('customTrackForm');
    
    if (section === 'custom') {
        filterSection.style.display = 'none';
        uploadSection.style.display = 'block';
        customForm.style.display = 'none';
        document.getElementById('tracksListTitle').textContent = '–ú–æ–∏ —Ç—Ä–µ–∫–∏';
    } else {
        filterSection.style.display = 'block';
        uploadSection.style.display = 'none';
        customForm.style.display = 'none';
        document.getElementById('tracksListTitle').textContent = section === 'favorites' ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–í—Å–µ —Ç—Ä–µ–∫–∏';
    }
    
    renderTrackList();
}

// Search and Filter
function filterTracks() {
    searchQuery = document.getElementById('trackSearch').value.toLowerCase();
    renderTrackList();
}

function setDifficultyFilter(diff) {
    haptic();
    currentDifficultyFilter = diff;
    
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    renderTrackList();
}

// Render Track List
function renderTrackList() {
    const list = document.getElementById('trackList');
    list.innerHTML = '';
    
    let tracksToShow = [];
    
    if (currentTrackSection === 'all') {
        tracksToShow = [...defaultTracks, ...customTracks];
    } else if (currentTrackSection === 'favorites') {
        tracksToShow = [...defaultTracks, ...customTracks].filter(t => favorites.includes(t.id));
    } else {
        tracksToShow = customTracks;
    }
    
    // Apply difficulty filter
    if (currentDifficultyFilter !== 'all') {
        tracksToShow = tracksToShow.filter(t => t.difficulty === currentDifficultyFilter);
    }
    
    // Apply search
    if (searchQuery) {
        tracksToShow = tracksToShow.filter(t => 
            t.title.toLowerCase().includes(searchQuery) || 
            t.artist.toLowerCase().includes(searchQuery)
        );
    }
    
    if (tracksToShow.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üéµ</div>
                <div>–¢—Ä–µ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
            </div>
        `;
        return;
    }
    
    tracksToShow.forEach(track => {
        const card = document.createElement('div');
        card.className = 'track-card';
        
        const isFav = favorites.includes(track.id);
        const diffClass = 'difficulty-' + track.difficulty;
        
        card.innerHTML = `
            <button class="favorite-btn ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${track.id}')">
                ${isFav ? '‚≠ê' : '‚òÜ'}
            </button>
            <div class="track-art">${track.emoji}</div>
            <div class="track-info">
                <div class="track-title">${track.title}</div>
                <div class="track-artist">${track.artist}</div>
                <div class="track-tags">
                    <span class="track-tag ${diffClass}">${track.difficulty}</span>
                    ${track.isCustom ? '<span class="track-tag">üì§ –ú–æ–π</span>' : ''}
                </div>
            </div>
            <button class="play-btn" onclick="event.stopPropagation(); quickPlay('${track.id}')">‚ñ∂</button>
        `;
        
        card.onclick = () => openTrackAnalysis(track);
        list.appendChild(card);
    });
}

// Favorites
function toggleFavorite(trackId) {
    haptic();
    const index = favorites.indexOf(trackId);
    if (index > -1) {
        favorites.splice(index, 1);
    } else {
        favorites.push(trackId);
    }
    saveData();
    renderTrackList();
}

// Custom Track Upload
function showUploadForm() {
    haptic();
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('customTrackForm').classList.add('active');
}

function hideUploadForm() {
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('customTrackForm').classList.remove('active');
}

function saveCustomTrack() {
    haptic();
    
    const artist = document.getElementById('customArtist').value.trim();
    const title = document.getElementById('customTitle').value.trim();
    const difficulty = document.getElementById('customDifficulty').value;
    const lyricsText = document.getElementById('customLyrics').value.trim();
    
    if (!artist || !title || !lyricsText) {
        tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!');
        return;
    }
    
    // Parse lyrics and auto-detect slang
    const lines = lyricsText.split('\n').filter(l => l.trim());
    const parsedLyrics = lines.map(line => {
        const detectedSlang = detectSlangInLine(line);
        return {
            original: line,
            rusTrans: generateRusTrans(line),
            clean: line,
            russian: '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –≤—Ä—É—á–Ω—É—é',
            slang: detectedSlang
        };
    });
    
    const newTrack = {
        id: 'custom-' + Date.now(),
        artist: artist,
        title: title,
        emoji: 'üéµ',
        difficulty: difficulty,
        preview: null,
        lyrics: parsedLyrics,
        isCustom: true
    };
    
    customTracks.push(newTrack);
    saveData();
    
    // Reset form
    document.getElementById('customArtist').value = '';
    document.getElementById('customTitle').value = '';
    document.getElementById('customLyrics').value = '';
    
    hideUploadForm();
    renderTrackList();
    
    tg.showPopup({
        title: '‚úÖ –¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!',
        message: '–¢–≤–æ–π —Ç—Ä–µ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ "–ú–æ–∏ —Ç—Ä–µ–∫–∏"',
        buttons: [{type: 'ok'}]
    });
    
    addStreetCred(50);
}

// Auto-detect slang in text
function detectSlangInLine(text) {
    const detected = [];
    const allSlang = [];
    
    // Collect all slang words
    Object.values(slangData).forEach(cat => {
        cat.forEach(subcat => {
            subcat.words.forEach(word => {
                allSlang.push({
                    word: word.word,
                    rusTrans: word.rus,
                    meaning: word.meaning,
                    explanation: word.context || word.origin || '–°–ª–µ–Ω–≥–æ–≤–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ'
                });
            });
        });
    });
    
    allSlang.forEach(slang => {
        const regex = new RegExp(`\\b${slang.word}\\b`, 'i');
        if (regex.test(text)) {
            detected.push(slang);
        }
    });
    
    return detected;
}

// Simple mock transcription generator
function generateRusTrans(englishText) {
    // This is a simplified mock - in real app you'd use a proper transcription service
    return '[' + englishText.split('').map(c => {
        const trans = {
            'a': '—ç', 'b': '–±', 'c': '–∫', 'd': '–¥', 'e': '–∏', 'f': '—Ñ',
            'g': '–≥', 'h': '—Ö', 'i': '–∞–π', 'j': '–¥–∂', 'k': '–∫', 'l': '–ª',
            'm': '–º', 'n': '–Ω', 'o': '–æ', 'p': '–ø', 'q': '–∫', 'r': '—Ä',
            's': '—Å', 't': '—Ç', 'u': '—É', 'v': '–≤', 'w': '—É', 'x': '–∫—Å',
            'y': '–∞–π', 'z': '–∑', ' ': ' ', '\'': ''
        };
        return trans[c.toLowerCase()] || c;
    }).join('') + ']';
}

// Track Analysis
function openTrackAnalysis(track) {
    haptic();
    currentTrack = track;
    currentPlayTime = 0;
    isPlaying = false;
    
    document.getElementById('analysisTitle').textContent = track.artist + ' - ' + track.title;
    document.getElementById('trackVisual').textContent = track.emoji;
    document.getElementById('difficultyBadge').textContent = track.difficulty;
    document.getElementById('difficultyBadge').className = 'difficulty-badge difficulty-' + track.difficulty;
    document.getElementById('lyricsTitle').textContent = track.title;
    
    // Generate lyrics with Russian transcription
    const lyricsContainer = document.getElementById('lyricsContent');
    lyricsContainer.innerHTML = '';
    
    track.lyrics.forEach((line, index) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'lyrics-line';
        
        let originalHTML = line.original;
        if (line.slang && line.slang.length > 0) {
            line.slang.forEach(s => {
                const regex = new RegExp(`\\b${s.word}\\b`, 'gi');
                originalHTML = originalHTML.replace(regex, `<span class="slang-word" onclick="showSlangExplanation('${s.word}', '${s.rusTrans}', '${s.meaning}', '${s.explanation}')">${s.word}</span>`);
            });
        }
        
        lineDiv.innerHTML = `
            <div class="original-line">${originalHTML}</div>
            <div class="rus-trans-block">
                <div class="rus-trans-title">üó£ –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ</div>
                <div class="rus-trans-text">${line.rusTrans}</div>
            </div>
            <div class="clean-line">${line.clean}</div>
            <div class="translation-line">${line.russian}</div>
            ${line.explanation ? `<div style="margin-top: 12px; font-size: 13px; color: rgba(255,255,255,0.5); font-style: italic;">üí° ${line.explanation}</div>` : ''}
        `;
        
        lyricsContainer.appendChild(lineDiv);
    });
    
    document.getElementById('mainScreen').classList.remove('active');
    document.getElementById('trackAnalysisScreen').classList.add('active');
}

function showSlangExplanation(word, rusTrans, meaning, explanation) {
    haptic();
    
    // Remove existing explanations
    document.querySelectorAll('.explanation-box').forEach(e => e.remove());
    
    const box = document.createElement('div');
    box.className = 'explanation-box show';
    box.innerHTML = `
        <div class="explanation-title">üî• ${word} <span style="opacity: 0.7; font-size: 14px;">${rusTrans}</span></div>
        <div style="color: #F7C59F; margin-bottom: 8px; font-weight: 600;">${meaning}</div>
        <div class="explanation-text">${explanation}</div>
    `;
    
    event.target.closest('.lyrics-line').appendChild(box);
}

// Player controls (same as before)
function togglePlay() {
    haptic();
    isPlaying = !isPlaying;
    const btn = document.getElementById('playBtn');
    const visualizer = document.getElementById('visualizer');
    
    if (isPlaying) {
        btn.textContent = '‚è∏';
        visualizer.classList.remove('paused');
        startPlayProgress();
    } else {
        btn.textContent = '‚ñ∂';
        visualizer.classList.add('paused');
        stopPlayProgress();
    }
}

function startPlayProgress() {
    playInterval = setInterval(() => {
        currentPlayTime += 0.1;
        if (currentPlayTime >= 30) {
            currentPlayTime = 0;
        }
        updateProgressBar();
    }, 100);
}

function stopPlayProgress() {
    clearInterval(playInterval);
}

function updateProgressBar() {
    const percent = (currentPlayTime / 30) * 100;
    document.getElementById('trackProgress').style.width = percent + '%';
    document.getElementById('currentTime').textContent = formatTime(currentPlayTime);
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + secs.toString().padStart(2, '0');
}

function skipBackward() {
    haptic();
    currentPlayTime = Math.max(0, currentPlayTime - 5);
    updateProgressBar();
}

function skipForward() {
    haptic();
    currentPlayTime = Math.min(30, currentPlayTime + 5);
    updateProgressBar();
}

function stopPlay() {
    isPlaying = false;
    document.getElementById('playBtn').textContent = '‚ñ∂';
    document.getElementById('visualizer').classList.add('paused');
    stopPlayProgress();
}

function showAnalysis() {
    haptic();
    stopPlay();
    document.getElementById('trackPlayer').style.display = 'none';
    document.getElementById('lyricsContainer').classList.add('active');
    addStreetCred(50);
}

function backToPlayer() {
    haptic();
    document.getElementById('trackPlayer').style.display = 'block';
    document.getElementById('lyricsContainer').classList.remove('active');
}

function closeTrackAnalysis() {
    haptic();
    stopPlay();
    document.getElementById('trackAnalysisScreen').classList.remove('active');
    document.getElementById('mainScreen').classList.add('active');
    document.getElementById('trackPlayer').style.display = 'block';
    document.getElementById('lyricsContainer').classList.remove('active');
}

function quickPlay(trackId) {
    haptic();
    const track = [...defaultTracks, ...customTracks].find(t => t.id === trackId);
    if (track) {
        openTrackAnalysis(track);
        setTimeout(() => togglePlay(), 300);
    }
}

// Slang Lessons (same as before)
function selectCategory(category, element) {
    haptic();
    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
    element.classList.add('active');
    currentCategory = category;
    renderSlangGrid();
}

function renderSlangGrid() {
    const grid = document.getElementById('slangGrid');
    grid.innerHTML = '';
    
    const categories = slangData[currentCategory];
    categories.forEach((cat, index) => {
        const card = document.createElement('div');
        card.className = 'level-card';
        card.onclick = () => startSlangLesson(index);
        
        card.innerHTML = `
            <div class="level-number">${index + 1}</div>
            <div class="level-name">${cat.name}</div>
            <div class="level-progress">${cat.words.length} —Å–ª–æ–≤</div>
        `;
        
        grid.appendChild(card);
    });
}

function startSlangLesson(categoryIndex) {
    haptic();
    isStreetLesson = true;
    const category = slangData[currentCategory][categoryIndex];
    currentLevel = { words: category.words, name: category.name, isStreet: true };
    currentCard = 0;
    isFlipped = false;
    lessonStartTime = Date.now();
    
    document.getElementById('flashcard').classList.add('street-card');
    updateStreetCard();
    generateDots();
    
    document.getElementById('mainScreen').classList.remove('active');
    document.getElementById('lessonScreen').classList.add('active');
    tg.MainButton.setText('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ‚úÖ');
    tg.MainButton.hide();
}

function updateStreetCard() {
    const w = currentLevel.words[currentCard];
    document.getElementById('cardWord').textContent = w.word;
    document.getElementById('cardTrans').textContent = w.trans;
    document.getElementById('cardRusTrans').textContent = w.rus;
    document.getElementById('cardMeaning').innerHTML = `
        <div class="street-badge">${currentCategory}</div>
        <div>${w.meaning}</div>
    `;
    document.getElementById('detailExample').textContent = w.example;
    document.getElementById('detailTranslation').innerHTML = `
        <div>${w.exampleRu}</div>
        ${w.context ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,107,53,0.3);"><strong>–ö–æ–Ω—Ç–µ–∫—Å—Ç:</strong> ${w.context}</div>` : ''}
        ${w.origin ? `<div style="margin-top: 8px;"><strong>–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:</strong> ${w.origin}</div>` : ''}
    `;
    
    document.getElementById('flashcard').classList.remove('flipped');
    document.getElementById('detailCard').classList.remove('show');
    
    const dots = document.querySelectorAll('.dot');
    dots.forEach((d, i) => {
        d.classList.remove('active', 'completed');
        if (i < currentCard) d.classList.add('completed');
        if (i === currentCard) d.classList.add('active');
    });
    
    const isLast = currentCard >= currentLevel.words.length - 1;
    tg.MainButton.setText(isLast ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫ üéâ' : '–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ ‚Üí');
}

// Standard lesson functions
function selectLevel(index) {
    haptic();
    isStreetLesson = false;
    currentLevel = levels[index];
    currentCard = 0;
    isFlipped = false;
    lessonStartTime = Date.now();
    updateCard();
    generateDots();
    document.getElementById('mainScreen').classList.remove('active');
    document.getElementById('lessonScreen').classList.add('active');
    tg.MainButton.setText('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ‚úÖ');
    tg.MainButton.hide();
}

function updateCard() {
    const w = currentLevel.words[currentCard];
    document.getElementById('cardWord').textContent = w.word;
    document.getElementById('cardTrans').textContent = w.trans;
    document.getElementById('cardRusTrans').textContent = w.rus;
    document.getElementById('cardMeaning').textContent = w.meaning;
    document.getElementById('detailExample').textContent = w.example;
    document.getElementById('detailTranslation').textContent = w.exampleRu;
    
    document.getElementById('flashcard').classList.remove('flipped');
    document.getElementById('detailCard').classList.remove('show');
    
    const dots = document.querySelectorAll('.dot');
    dots.forEach((d, i) => {
        d.classList.remove('active', 'completed');
        if (i < currentCard) d.classList.add('completed');
        if (i === currentCard) d.classList.add('active');
    });
    
    const isLast = currentCard >= currentLevel.words.length - 1;
    tg.MainButton.setText(isLast ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫ üéâ' : '–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ ‚Üí');
}

function generateDots() {
    const container = document.getElementById('progressDots');
    container.innerHTML = '';
    const wordCount = currentLevel.words.length;
    
    for (let i = 0; i < wordCount; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot';
        container.appendChild(dot);
    }
}

function flipCard() {
    if (isFlipped) return;
    haptic();
    isFlipped = true;
    document.getElementById('flashcard').classList.add('flipped');
    
    setTimeout(() => {
        document.getElementById('detailCard').classList.add('show');
        tg.MainButton.show();
    }, 300);
}

function toggleTrans() {
    haptic();
    showRusTrans = !showRusTrans;
    document.getElementById('transToggle').classList.toggle('active');
    document.getElementById('cardRusTrans').style.display = showRusTrans ? 'block' : 'none';
}

function closeLesson() {
    haptic();
    if (confirm('–ü—Ä–µ—Ä–≤–∞—Ç—å —É—Ä–æ–∫?')) {
        document.getElementById('lessonScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        tg.MainButton.hide();
        document.getElementById('flashcard').classList.remove('street-card');
        isStreetLesson = false;
    }
}

// Street Cred
function addStreetCred(amount) {
    streetCred += amount;
    updateStreetStats();
    saveData();
}

function updateStreetStats() {
    document.getElementById('streetCred').textContent = streetCred;
    const level = Math.floor(streetCred / 100) + 1;
    const nextLevel = level * 100;
    const progress = (streetCred % 100);
    
    document.getElementById('streetLevel').textContent = level;
    document.getElementById('streetNext').textContent = nextLevel - streetCred;
    document.getElementById('streetProgress').style.width = progress + '%';
}

// Finish lesson
function finishLesson() {
    haptic();
    
    if (isStreetLesson) {
        addStreetCred(100);
        
        const timeSpent = Math.floor((Date.now() - lessonStartTime) / 1000);
        const mins = Math.floor(timeSpent / 60);
        const secs = timeSpent % 60;
        
        document.getElementById('timeValue').textContent = mins + ':' + secs.toString().padStart(2, '0');
        document.getElementById('resultWords').textContent = currentLevel.words.length;
        document.getElementById('resultXP').textContent = '+100 STREET CRED';
        document.getElementById('xpLabel').textContent = 'Street Cred';
        document.getElementById('resultSubtitle').textContent = '–£—Ä–æ–≤–µ–Ω—å "' + currentLevel.name + '" –ø—Ä–æ–π–¥–µ–Ω!';
        
        document.getElementById('resultScreen').classList.add('active');
        document.getElementById('lessonScreen').classList.remove('active');
        tg.MainButton.hide();
        
        isStreetLesson = false;
        document.getElementById('flashcard').classList.remove('street-card');
    } else {
        // Standard finish
        document.getElementById('resultScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        tg.MainButton.hide();
    }
}

// Render levels
function renderLevels() {
    const grid = document.getElementById('levelGrid');
    grid.innerHTML = '';
    
    levels.forEach((level, index) => {
        const card = document.createElement('div');
        card.className = 'level-card';
        card.onclick = () => selectLevel(index);
        
        card.innerHTML = `
            <div class="level-number">${level.id}</div>
            <div class="level-name">${level.name}</div>
            <div class="level-progress">${level.words.length} —Å–ª–æ–≤</div>
        `;
        
        grid.appendChild(card);
    });
}

// Chat
function openChat() {
    haptic();
    tg.showAlert('AI-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω! ü¶ú');
}

// Main button handler
tg.MainButton.onClick(() => {
    haptic();
    if (!isFlipped) {
        flipCard();
        return;
    }
    
    currentCard++;
    
    if (currentCard >= currentLevel.words.length) {
        const timeSpent = Math.floor((Date.now() - lessonStartTime) / 1000);
        const mins = Math.floor(timeSpent / 60);
        const secs = timeSpent % 60;
        document.getElementById('timeValue').textContent = mins + ':' + secs.toString().padStart(2, '0');
        document.getElementById('resultWords').textContent = currentLevel.words.length;
        document.getElementById('resultXP').textContent = isStreetLesson ? '+100 STREET CRED' : '+100 XP';
        document.getElementById('resultSubtitle').textContent = '–£—Ä–æ–≤–µ–Ω—å "' + currentLevel.name + '" –ø—Ä–æ–π–¥–µ–Ω!';
        
        document.getElementById('lessonScreen').classList.remove('active');
        document.getElementById('resultScreen').classList.add('active');
        tg.MainButton.hide();
    } else {
        isFlipped = false;
        if (isStreetLesson) {
            updateStreetCard();
        } else {
            updateCard();
        }
        tg.MainButton.hide();
    }
});

// Init
let currentCard = 0;
let isFlipped = false;
let showRusTrans = false;
let lessonStartTime = null;
let currentLevel = null;

document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
